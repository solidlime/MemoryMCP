<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory MCP Dashboard üß†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="p-6">
    <!-- Header -->
    <header class="glass-card rounded-2xl p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">üß† Memory MCP Dashboard</h1>
                <p class="text-purple-200">Visualize your memories and knowledge</p>
            </div>
            <div class="flex items-center gap-4">
                <label class="text-white font-semibold">Persona:</label>
                <select id="personaSelect" class="glass-card rounded-lg px-4 py-2 text-white font-semibold cursor-pointer">
                    <option value="">Loading...</option>
                </select>
                <button onclick="refreshData()" class="glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    </header>

    <!-- Info & Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Info Card -->
        <div class="glass-card rounded-2xl p-6">
            <h2 class="text-2xl font-bold text-white mb-4">üìä Memory Info</h2>
            <div id="infoContent" class="text-white space-y-2 loading">
                <p>Loading...</p>
            </div>
        </div>

        <!-- Metrics Card -->
        <div class="glass-card rounded-2xl p-6">
            <h2 class="text-2xl font-bold text-white mb-4">üìà Metrics</h2>
            <div id="metricsContent" class="text-white space-y-2 loading">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Stats Card -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üìâ Statistics</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-xl text-white mb-3">üìÖ 7-Day Timeline</h3>
                <canvas id="timelineChart"></canvas>
            </div>
            <div>
                <h3 class="text-xl text-white mb-3">üè∑Ô∏è Tag Distribution</h3>
                <canvas id="tagChart"></canvas>
            </div>
        </div>
        <div class="mt-6">
            <h3 class="text-xl text-white mb-3">üîó Top Links</h3>
            <div id="topLinksContent" class="text-white space-y-1">
                Loading...
            </div>
        </div>
    </div>

    <!-- Emotion Timeline Card (NEW) -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üí≠ Emotion Timeline</h2>
        <div class="mb-4 flex gap-4">
            <button id="showDaily" onclick="showEmotionView('daily')"
                    class="glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                üìÖ Daily
            </button>
            <button id="showWeekly" onclick="showEmotionView('weekly')"
                    class="glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition bg-white/20">
                üìä Weekly
            </button>
        </div>
        <div>
            <canvas id="emotionChart" style="max-height: 400px;"></canvas>
        </div>
        <div id="emotionLegend" class="mt-4 text-white text-sm">
            Loading emotion data...
        </div>
    </div>

    <!-- Physical Sensations Timeline Card (NEW) -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üí´ Physical Sensations Timeline</h2>
        <div>
            <canvas id="physicalSensationsChart" style="max-height: 400px;"></canvas>
        </div>
        <div id="physicalSensationsLegend" class="mt-4 text-white text-sm">
            Loading physical sensations data...
        </div>
    </div>

    <!-- Anniversary Calendar Card (NEW) -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üéÇ Anniversary Calendar</h2>
        <div id="anniversaryCalendar" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <p class="text-white loading col-span-full">Loading anniversaries...</p>
        </div>
        <div id="anniversaryLegend" class="mt-4 text-white text-sm">
            Memories tagged with 'anniversary', 'milestone', or 'first_time' grouped by month and day
        </div>
    </div>

    <!-- Anniversary Modal -->
    <div id="anniversaryModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-6">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white" id="modalTitle">Memories</h3>
                <button onclick="closeAnniversaryModal()" class="text-white hover:text-purple-200 text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4"></div>
        </div>
    </div>

    <!-- Observation Stream Card -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üìã Observation Stream</h2>
        <div class="flex flex-wrap gap-2 mb-4">
            <input type="text" id="obsSearchQuery" placeholder="Search keyword..." class="bg-white/10 text-white rounded-lg px-3 py-2 text-sm border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400 w-48">
            <input type="text" id="obsSearchTag" placeholder="Filter by tag..." class="bg-white/10 text-white rounded-lg px-3 py-2 text-sm border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400 w-36">
            <button onclick="loadObservations(1)" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-all">üîç Search</button>
        </div>
        <div id="observationList" class="space-y-3">
            <p class="text-white loading">Loading observations...</p>
        </div>
        <div id="obsPagination" class="flex items-center justify-center gap-4 mt-4 hidden">
            <button onclick="loadObservations(currentObsPage - 1)" id="obsPrev" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm">‚Üê Prev</button>
            <span id="obsPageInfo" class="text-white text-sm"></span>
            <button onclick="loadObservations(currentObsPage + 1)" id="obsNext" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm">Next ‚Üí</button>
        </div>
    </div>

    <!-- Audit Log Card -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üìù Audit Log</h2>
        <div class="flex flex-wrap gap-2 mb-4">
            <select id="auditOpFilter" class="bg-white/10 text-white rounded-lg px-3 py-2 text-sm border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="">All Operations</option>
                <option value="create">Create</option>
                <option value="read">Read</option>
                <option value="update">Update</option>
                <option value="delete">Delete</option>
                <option value="search">Search</option>
            </select>
            <input type="text" id="auditKeyFilter" placeholder="Filter by key..." class="bg-white/10 text-white rounded-lg px-3 py-2 text-sm border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400 w-48">
            <button onclick="loadAuditLog(1)" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-all">üîç Filter</button>
        </div>
        <div id="auditBreakdown" class="flex flex-wrap gap-2 mb-4"></div>
        <div id="auditLogList" class="space-y-2">
            <p class="text-white loading">Loading audit log...</p>
        </div>
        <div id="auditPagination" class="flex items-center justify-center gap-4 mt-4 hidden">
            <button onclick="loadAuditLog(currentAuditPage - 1)" id="auditPrev" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm">‚Üê Prev</button>
            <span id="auditPageInfo" class="text-white text-sm"></span>
            <button onclick="loadAuditLog(currentAuditPage + 1)" id="auditNext" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm">Next ‚Üí</button>
        </div>
    </div>

    <!-- Admin Tools Card -->
    <div class="glass-card rounded-2xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-white mb-4">üõ†Ô∏è Admin Tools</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Clean Memory -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üßπ Clean Memory</h3>
                <p class="text-purple-200 text-sm mb-3">Remove duplicate lines from a memory</p>
                <input type="text" id="cleanMemoryKey" placeholder="memory_YYYYMMDDHHMMSS"
                       class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-purple-200 mb-2">
                <button onclick="cleanMemory()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    Clean
                </button>
            </div>

            <!-- Rebuild Qdrant Collection -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üîÑ Rebuild Qdrant Collection</h3>
                <p class="text-purple-200 text-sm mb-3">Rebuild Qdrant vectors from SQLite database</p>
                <button onclick="rebuildVectorStore()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition mt-8">
                    Rebuild
                </button>
            </div>

            <!-- Migrate Backend -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üîÄ Migrate Backend</h3>
                <p class="text-purple-200 text-sm mb-3">Migrate between SQLite ‚áî Qdrant</p>
                <select id="migrateSource" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white mb-2">
                    <option value="sqlite">SQLite</option>
                    <option value="qdrant">Qdrant</option>
                </select>
                <select id="migrateTarget" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white mb-2">
                    <option value="qdrant">Qdrant</option>
                    <option value="sqlite">SQLite</option>
                </select>
                <button onclick="migrateBackend()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    Migrate
                </button>
            </div>

            <!-- Detect Duplicates -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üîç Detect Duplicates</h3>
                <p class="text-purple-200 text-sm mb-3">Find similar memories</p>
                <input type="number" id="duplicateThreshold" placeholder="Threshold (0.0-1.0)"
                       value="0.85" step="0.05" min="0" max="1"
                       class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-purple-200 mb-2">
                <button onclick="detectDuplicates()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    Detect
                </button>
            </div>

            <!-- Merge Memories -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üîó Merge Memories</h3>
                <p class="text-purple-200 text-sm mb-3">Combine multiple memories (comma-separated keys)</p>
                <input type="text" id="mergeKeys" placeholder="key1,key2,key3"
                       class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-purple-200 mb-2">
                <button onclick="mergeMemories()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    Merge
                </button>
            </div>

            <!-- Generate Knowledge Graph -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üï∏Ô∏è Generate Graph</h3>
                <p class="text-purple-200 text-sm mb-3">Create new knowledge graph</p>
                <button onclick="generateGraph()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition mt-8">
                    Generate
                </button>
            </div>

            <!-- Create Summary -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üìù Create Summary</h3>
                <p class="text-purple-200 text-sm mb-3">Generate memory summary</p>
                <select id="summaryPeriod" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white mb-2">
                    <option value="day">Last Day</option>
                    <option value="week">Last Week</option>
                </select>
                <button onclick="createSummary()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition">
                    Create
                </button>
            </div>

            <!-- Migrate Schema -->
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">üîß Migrate Schema</h3>
                <p class="text-purple-200 text-sm mb-3">Update database schema (add missing columns)</p>
                <button onclick="migrateSchema()"
                        class="w-full glass-card rounded-lg px-4 py-2 text-white font-semibold hover:bg-white/20 transition mt-8">
                    Migrate
                </button>
            </div>
        </div>

        <!-- Result Display Area -->
        <div id="adminResult" class="mt-4 hidden">
            <div class="glass-card rounded-lg p-4">
                <h3 class="text-lg font-semibold text-white mb-2">Result</h3>

                <!-- Progress Display Area (moved here) -->
                <div id="progressContainer" class="mb-4 hidden">
                    <div class="glass-card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-white" id="progressTitle">Processing...</h3>
                            <span class="text-purple-200 font-semibold" id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-4 overflow-hidden">
                            <div id="progressBar" class="bg-gradient-to-r from-purple-400 to-pink-400 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-purple-200 text-sm mt-2" id="progressMessage">Starting...</p>
                    </div>
                </div>

                <pre id="adminResultContent" class="text-white text-sm overflow-auto max-h-96"></pre>
            </div>
        </div>
    </div>

    <!-- Knowledge Graph Card -->
    <div class="glass-card rounded-2xl p-6">
        <h2 class="text-2xl font-bold text-white mb-4">üï∏Ô∏è Knowledge Graph</h2>
        <div id="knowledgeGraphContent" class="bg-white rounded-lg" style="height: 600px;">
            <div class="flex items-center justify-center h-full text-gray-500">
                <p class="loading">Loading Knowledge Graph...</p>
            </div>
        </div>
    </div>

    <script>
        let currentPersona = '';
        let timelineChart = null;
        let tagChart = null;
        let emotionChart = null;
        let emotionData = null;
        let emotionView = 'weekly'; // 'daily' or 'weekly'
        let physicalSensationsChart = null;
        let physicalSensationsData = null;
        let anniversariesData = null;

        // Load personas on page load
        async function loadPersonas() {
            try {
                const response = await fetch('/api/personas');
                const personas = await response.json();
                const select = document.getElementById('personaSelect');
                select.innerHTML = personas.map(p =>
                    `<option value="${p}">${p}</option>`
                ).join('');

                // Load first persona by default
                if (personas.length > 0) {
                    currentPersona = personas[0];
                    select.value = currentPersona;
                    await loadDashboardData(currentPersona);
                }
            } catch (error) {
                console.error('Failed to load personas:', error);
                document.getElementById('personaSelect').innerHTML = '<option>Error loading personas</option>';
            }
        }

        // Persona selection change
        document.getElementById('personaSelect').addEventListener('change', async (e) => {
            const newPersona = e.target.value;
            console.log(`Persona changed from "${currentPersona}" to "${newPersona}"`);
            currentPersona = newPersona;
            await loadDashboardData(currentPersona);
        });

        // Refresh data
        async function refreshData() {
            if (currentPersona) {
                await loadDashboardData(currentPersona);
            }
        }

        // Load dashboard data
        async function loadDashboardData(persona) {
            console.log(`Loading dashboard data for persona: ${persona}`);
            try {
                const response = await fetch(`/api/dashboard/${persona}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Dashboard data loaded:', data);

                // Update Info
                renderInfo(data.info);

                // Update Metrics
                renderMetrics(data.metrics);

                // Update Stats
                renderStats(data.stats);

                // Update Knowledge Graph
                renderKnowledgeGraph(data.knowledge_graph_url);

                // Load Emotion Timeline
                await loadEmotionData(persona);

                // Load Physical Sensations Timeline
                await loadPhysicalSensationsData(persona);

                // Load Anniversaries
                await loadAnniversariesData(persona);

                // Load Observation Stream & Audit Log
                loadObservations(1);
                loadAuditLog(1);

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showAdminResult(`Failed to load data: ${error.message}`, true);
            }
        }

        function renderInfo(info) {
            const content = document.getElementById('infoContent');
            content.classList.remove('loading');

            // Ë£ÖÂÇôÂìÅË°®Á§∫„Çí‰ΩúÊàê
            let equipmentHtml = '';
            if (info.current_equipment && Object.keys(info.current_equipment).length > 0) {
                equipmentHtml = '<div class="mt-3 pt-3 border-t border-white/20"><p class="font-semibold mb-2">üëó Current Equipment:</p><div class="space-y-1 text-sm">';
                for (const [slot, item] of Object.entries(info.current_equipment)) {
                    equipmentHtml += `<p class="ml-2">‚öîÔ∏è <span class="text-purple-200">${slot}:</span> ${item}</p>`;
                }
                equipmentHtml += '</div></div>';
            }

            content.innerHTML = `
                <div class="space-y-2">
                    <p class="text-lg"><span class="font-semibold">üí≠ Total Memories:</span> ${info.total_memories || 0}</p>
                    <p><span class="font-semibold">üìÖ Database Created:</span> ${info.created_at || 'N/A'}</p>
                    <p><span class="font-semibold">üïê Last Conversation:</span> ${info.last_conversation || 'N/A'}</p>
                    <p><span class="font-semibold">üòä Current Emotion:</span> ${info.current_emotion || 'neutral'}</p>
                    <p><span class="font-semibold">üèÉ Physical State:</span> ${info.physical_state || 'normal'}</p>
                    <p><span class="font-semibold">üß† Mental State:</span> ${info.mental_state || 'calm'}</p>
                    <p><span class="font-semibold">üåü Relationship:</span> ${info.relationship_status || 'normal'}</p>
                    ${equipmentHtml}
                </div>
            `;
        }

        function renderMetrics(metrics) {
            const content = document.getElementById('metricsContent');
            content.classList.remove('loading');

            const topTags = metrics.top_tags ? Object.entries(metrics.top_tags)
                .slice(0, 5)
                .map(([tag, count]) => `<span class="inline-block bg-white/20 rounded-full px-3 py-1 text-sm">${tag} (${count})</span>`)
                .join(' ') : 'No tags';

            const topEmotions = metrics.emotion_distribution ? Object.entries(metrics.emotion_distribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([emotion, count]) => `<span class="inline-block bg-white/20 rounded-full px-3 py-1 text-sm">${emotion} (${count})</span>`)
                .join(' ') : 'No emotions';

            content.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <p class="font-semibold mb-2">üè∑Ô∏è Top Tags:</p>
                        <div class="flex flex-wrap gap-2">${topTags}</div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">üòä Top Emotions:</p>
                        <div class="flex flex-wrap gap-2">${topEmotions}</div>
                    </div>
                    <p><span class="font-semibold">üìä Tagged Memories:</span> ${metrics.tagged_memories_count || 0}</p>
                    <p><span class="font-semibold">üîó Linked Memories:</span> ${metrics.linked_memories_count || 0}</p>
                </div>
            `;
        }

        function renderStats(stats) {
            // Timeline Chart (configurable days, default 14)
            const timelineData = stats.timeline || stats.last_7_days;
            if (timelineData) {
                const ctx = document.getElementById('timelineChart');
                if (timelineChart) timelineChart.destroy();

                const labels = timelineData.map(d => d.date);
                const data = timelineData.map(d => d.count);

                timelineChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Memories Created',
                            data: data,
                            backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            borderColor: 'rgba(255, 255, 255, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Tag Chart
            if (stats.tag_distribution) {
                const ctx = document.getElementById('tagChart');
                if (tagChart) tagChart.destroy();

                // Show top 8 tags + "Others" for remaining tags
                const allTags = Object.entries(stats.tag_distribution).sort((a, b) => b[1] - a[1]);
                const topTags = allTags.slice(0, 8);
                const otherTags = allTags.slice(8);

                let tagEntries = topTags;
                if (otherTags.length > 0) {
                    const otherCount = otherTags.reduce((sum, [_, count]) => sum + count, 0);
                    tagEntries.push(['Others', otherCount]);
                }
                const labels = tagEntries.map(([tag, _]) => tag);
                const data = tagEntries.map(([_, count]) => count);

                tagChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(201, 203, 207, 0.7)',
                                'rgba(255, 99, 255, 0.7)',
                                'rgba(128, 128, 128, 0.7)'  // Others in gray
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: 'white' }
                            }
                        }
                    }
                });
            }

            // Top Links
            if (stats.top_links) {
                const content = document.getElementById('topLinksContent');
                const links = Object.entries(stats.top_links)
                    .slice(0, 10)
                    .map(([link, count]) => `<span class="inline-block bg-white/20 rounded-full px-3 py-1 text-sm mr-2 mb-2">${link} (${count})</span>`)
                    .join('');
                content.innerHTML = links || '<p class="text-purple-200">No links found</p>';
            }
        }

        function renderKnowledgeGraph(url) {
            const content = document.getElementById('knowledgeGraphContent');
            if (url) {
                content.innerHTML = `<iframe src="${url}" class="w-full h-full rounded-lg" frameborder="0"></iframe>`;
            } else {
                content.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <p>No Knowledge Graph available. Generate one using the generate_knowledge_graph tool!</p>
                    </div>
                `;
            }
        }

        // Load emotion timeline data
        async function loadEmotionData(persona) {
            try {
                const response = await fetch(`/api/emotion-timeline/${persona}`);
                const result = await response.json();

                if (result.success) {
                    emotionData = result;
                    renderEmotionChart();
                } else {
                    document.getElementById('emotionLegend').innerHTML =
                        `<p class="text-red-300">Failed to load emotion data: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('Failed to load emotion data:', error);
                document.getElementById('emotionLegend').innerHTML =
                    '<p class="text-red-300">Error loading emotion data</p>';
            }
        }

        // Render emotion chart based on current view (daily/weekly)
        function renderEmotionChart() {
            if (!emotionData) return;

            const ctx = document.getElementById('emotionChart');
            if (emotionChart) emotionChart.destroy();

            const data = emotionView === 'daily' ? emotionData.daily : emotionData.weekly;
            const labelKey = emotionView === 'daily' ? 'date' : 'week';

            if (!data || data.length === 0) {
                document.getElementById('emotionLegend').innerHTML =
                    '<p class="text-purple-200">No emotion data available</p>';
                return;
            }

            // Prepare datasets for each emotion
            const emotionColors = {
                'joy': 'rgba(255, 206, 86, 0.8)',
                'love': 'rgba(255, 99, 132, 0.8)',
                'sadness': 'rgba(54, 162, 235, 0.8)',
                'anger': 'rgba(255, 99, 71, 0.8)',
                'fear': 'rgba(153, 102, 255, 0.8)',
                'surprise': 'rgba(255, 159, 64, 0.8)',
                'calm': 'rgba(75, 192, 192, 0.8)',
                'excitement': 'rgba(255, 140, 0, 0.8)'
            };

            const labels = data.map(item => item[labelKey]);
            const datasets = emotionData.emotion_types.map(emotion => ({
                label: emotion.charAt(0).toUpperCase() + emotion.slice(1),
                data: data.map(item => item[emotion] || 0),
                backgroundColor: emotionColors[emotion] || 'rgba(200, 200, 200, 0.8)',
                borderColor: emotionColors[emotion]?.replace('0.8', '1') || 'rgba(200, 200, 200, 1)',
                borderWidth: 2,
                fill: true
            }));

            emotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', padding: 15 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Update legend info
            const totalEmotions = data.reduce((sum, item) => {
                return sum + emotionData.emotion_types.reduce((s, e) => s + (item[e] || 0), 0);
            }, 0);
            document.getElementById('emotionLegend').innerHTML =
                `<p>üìä Total emotional memories: ${totalEmotions} | View: ${emotionView === 'daily' ? 'Daily' : 'Weekly'}</p>`;
        }

        // Toggle emotion view (daily/weekly)
        function showEmotionView(view) {
            emotionView = view;

            // Update button styles
            document.getElementById('showDaily').classList.toggle('bg-white/20', view === 'daily');
            document.getElementById('showWeekly').classList.toggle('bg-white/20', view === 'weekly');

            renderEmotionChart();
        }

        // Load physical sensations timeline data
        async function loadPhysicalSensationsData(persona) {
            try {
                const response = await fetch(`/api/physical-sensations-timeline/${persona}`);
                const result = await response.json();

                if (result.success) {
                    physicalSensationsData = result;
                    renderPhysicalSensationsChart();
                } else {
                    document.getElementById('physicalSensationsLegend').innerHTML =
                        `<p class="text-red-300">Failed to load physical sensations data: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('Failed to load physical sensations data:', error);
                document.getElementById('physicalSensationsLegend').innerHTML =
                    '<p class="text-red-300">Error loading physical sensations data</p>';
            }
        }

        // Render physical sensations chart
        function renderPhysicalSensationsChart() {
            if (!physicalSensationsData || !physicalSensationsData.timeline || physicalSensationsData.timeline.length === 0) {
                document.getElementById('physicalSensationsLegend').innerHTML =
                    '<p class="text-purple-200">No physical sensations data available</p>';
                return;
            }

            const ctx = document.getElementById('physicalSensationsChart');
            if (physicalSensationsChart) physicalSensationsChart.destroy();

            // Extract timestamps and metrics
            const labels = physicalSensationsData.timeline.map(item => {
                const date = new Date(item.timestamp);
                return date.toLocaleString('ja-JP', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            });

            // Define colors for each metric
            const metricColors = {
                'fatigue': 'rgba(255, 99, 132, 0.8)',          // Red
                'warmth': 'rgba(255, 159, 64, 0.8)',           // Orange
                'arousal': 'rgba(255, 99, 255, 0.8)',          // Pink
                'touch_response': 'rgba(153, 102, 255, 0.8)',  // Purple
                'heart_rate_metaphor': 'rgba(255, 206, 86, 0.8)' // Yellow
            };

            const metricLabels = {
                'fatigue': 'Fatigue',
                'warmth': 'Warmth',
                'arousal': 'Arousal',
                'touch_response': 'Touch Response',
                'heart_rate_metaphor': 'Heart Rate'
            };

            // Create datasets for each metric
            const datasets = physicalSensationsData.metrics.map(metric => ({
                label: metricLabels[metric],
                data: physicalSensationsData.timeline.map(item => item[metric]),
                backgroundColor: metricColors[metric],
                borderColor: metricColors[metric].replace('0.8', '1'),
                borderWidth: 2,
                fill: false,
                tension: 0.3
            }));

            physicalSensationsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', padding: 15 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 1.0,
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Update legend info
            document.getElementById('physicalSensationsLegend').innerHTML =
                `<p>üí´ Physical Sensations Timeline (Last 7 days) | Total data points: ${physicalSensationsData.timeline.length}</p>`;
        }

        // Load anniversaries data
        async function loadAnniversariesData(persona) {
            try {
                const response = await fetch(`/api/anniversaries/${persona}`);
                const result = await response.json();

                if (result.success) {
                    anniversariesData = result.anniversaries;
                    renderAnniversariesCalendar();
                } else {
                    document.getElementById('anniversaryLegend').innerHTML =
                        `<p class="text-red-300">Failed to load anniversaries: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('Failed to load anniversaries:', error);
                document.getElementById('anniversaryLegend').innerHTML =
                    '<p class="text-red-300">Error loading anniversaries</p>';
            }
        }

        // Render anniversaries calendar
        function renderAnniversariesCalendar() {
            const calendar = document.getElementById('anniversaryCalendar');

            if (!anniversariesData || anniversariesData.length === 0) {
                calendar.innerHTML = '<p class="text-white col-span-full">No anniversaries found. Use tags: anniversary, milestone, first_time</p>';
                return;
            }

            // Create month cards
            const monthNames = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            const monthNamesFull = ['January', 'February', 'March', 'April', 'May', 'June',
                                     'July', 'August', 'September', 'October', 'November', 'December'];

            // Group by month
            const byMonth = {};
            anniversariesData.forEach(item => {
                const month = item.month_day.split('-')[0];
                if (!byMonth[month]) {
                    byMonth[month] = [];
                }
                byMonth[month].push(item);
            });

            // Generate month cards
            let html = '';
            monthNames.forEach((month, idx) => {
                const monthData = byMonth[month] || [];
                const totalCount = monthData.reduce((sum, item) => sum + item.count, 0);

                if (totalCount > 0) {
                    html += `
                        <div class="glass-card rounded-lg p-4 hover:bg-white/20 transition cursor-pointer"
                             onclick="showMonthAnniversaries('${month}', '${monthNamesFull[idx]}')">
                            <h3 class="text-xl font-bold text-white mb-2">${monthNamesFull[idx]}</h3>
                            <p class="text-purple-200 text-sm mb-2">${monthData.length} anniversaries</p>
                            <div class="flex flex-wrap gap-1">
                                ${monthData.map(item => {
                                    const day = item.month_day.split('-')[1];
                                    return `<span class="inline-block bg-purple-400 rounded-full w-8 h-8 text-center leading-8 text-white text-xs font-semibold" title="${item.count} memories">${day}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            if (html === '') {
                calendar.innerHTML = '<p class="text-white col-span-full">No important anniversaries found</p>';
            } else {
                calendar.innerHTML = html;
                document.getElementById('anniversaryLegend').innerHTML =
                    `<p>üéÇ Total anniversaries: ${anniversariesData.length} days with anniversary/milestone/first_time tags</p>`;
            }
        }

        // Show anniversaries for a specific month
        function showMonthAnniversaries(month, monthName) {
            const monthData = anniversariesData.filter(item => item.month_day.startsWith(month + '-'));

            const modal = document.getElementById('anniversaryModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `${monthName} Anniversaries`;

            let html = '';
            monthData.forEach(dayData => {
                const day = dayData.month_day.split('-')[1];
                html += `
                    <div class="glass-card rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-white mb-2">${monthName} ${day} (${dayData.count} memories)</h4>
                        <div class="space-y-2">
                            ${dayData.memories.map(mem => {
                                const emotionIcon = {
                                    'joy': 'üòä', 'love': 'üíï', 'sadness': 'üò¢',
                                    'anger': 'üò†', 'fear': 'üò®', 'surprise': 'üò≤',
                                    'calm': 'üòå', 'excitement': 'ü§©'
                                }[mem.emotion] || 'üí≠';

                                const tagsHtml = mem.tags && mem.tags.length > 0
                                    ? `<div class="flex flex-wrap gap-1 mt-1">
                                        ${mem.tags.map(tag => `<span class="inline-block bg-white/20 rounded-full px-2 py-0.5 text-xs">${tag}</span>`).join('')}
                                       </div>`
                                    : '';

                                return `
                                    <div class="bg-white/10 rounded p-3">
                                        <div class="flex justify-between items-start mb-1">
                                            <span class="text-purple-200 text-xs">${mem.year} ${emotionIcon}</span>
                                            <span class="text-yellow-300 text-xs">‚≠ê ${mem.importance.toFixed(2)}</span>
                                        </div>
                                        <p class="text-white text-sm">${mem.preview}${mem.preview.length >= 100 ? '...' : ''}</p>
                                        ${tagsHtml}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            modalContent.innerHTML = html;
            modal.classList.remove('hidden');
        }

        // Close anniversary modal
        function closeAnniversaryModal() {
            document.getElementById('anniversaryModal').classList.add('hidden');
        }

        // Initialize on page load
        loadPersonas();

        // ========================================
        // Admin Tools Functions
        // ========================================

        // Progress bar functions
        function showProgress(title = 'Processing...', message = 'Starting...') {
            const resultDiv = document.getElementById('adminResult');
            const container = document.getElementById('progressContainer');
            const titleEl = document.getElementById('progressTitle');
            const messageEl = document.getElementById('progressMessage');
            const percentEl = document.getElementById('progressPercent');
            const bar = document.getElementById('progressBar');

            // Show result area first
            resultDiv.classList.remove('hidden');

            titleEl.textContent = title;
            messageEl.textContent = message;
            percentEl.textContent = '0%';
            bar.style.width = '0%';
            container.classList.remove('hidden');
        }

        function updateProgress(percent, message = '') {
            const percentEl = document.getElementById('progressPercent');
            const messageEl = document.getElementById('progressMessage');
            const bar = document.getElementById('progressBar');

            percentEl.textContent = `${percent}%`;
            bar.style.width = `${percent}%`;
            if (message) {
                messageEl.textContent = message;
            }
        }

        function hideProgress() {
            // Keep progress bar visible to show completion state
            // It will remain in the result area
        }

        function showAdminResult(result, isError = false) {
            const resultDiv = document.getElementById('adminResult');
            const resultContent = document.getElementById('adminResultContent');
            resultDiv.classList.remove('hidden');

            if (isError) {
                resultContent.className = 'text-red-300 text-sm overflow-auto max-h-96';
            } else {
                resultContent.className = 'text-white text-sm overflow-auto max-h-96';
            }

            resultContent.textContent = typeof result === 'string' ? result : JSON.stringify(result, null, 2);

            // Auto-hide after 10 seconds for success messages
            if (!isError) {
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 10000);
            }
        }

        async function cleanMemory() {
            const key = document.getElementById('cleanMemoryKey').value.trim();
            if (!key) {
                showAdminResult('Error: Please enter a memory key', true);
                return;
            }

            if (!confirm(`Clean memory "${key}" for persona "${currentPersona}"?\nThis will remove duplicate entries.`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/clean', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona: currentPersona, key: key })
                });
                const result = await response.json();

                if (result.success) {
                    showAdminResult(result.message);
                    document.getElementById('cleanMemoryKey').value = '';
                } else {
                    showAdminResult(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function rebuildVectorStore() {
            if (!confirm(`Rebuild Qdrant collection for persona "${currentPersona}"?`)) return;

            showProgress('Rebuilding Vector Store', 'Initializing...');

            try {
                const response = await fetch('/api/admin/rebuild-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona: currentPersona })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));

                            if (data.status === 'progress') {
                                updateProgress(data.percent, data.message);
                            } else if (data.status === 'completed') {
                                updateProgress(100, data.message);
                                setTimeout(() => {
                                    hideProgress();
                                    showAdminResult(data.message);
                                    refreshData();
                                }, 1000);
                            } else if (data.status === 'error') {
                                hideProgress();
                                showAdminResult(`Error: ${data.message}`, true);
                            }
                        }
                    }
                }
            } catch (error) {
                hideProgress();
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function migrateBackend() {
            const source = document.getElementById('migrateSource').value;
            const target = document.getElementById('migrateTarget').value;

            if (source === target) {
                showAdminResult('Error: Source and target must be different', true);
                return;
            }

            if (!confirm(`Migrate from ${source} to ${target} for persona "${currentPersona}"?`)) return;

            try {
                const response = await fetch('/api/admin/migrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        source: source,
                        target: target
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAdminResult(`${result.message} (${result.count} memories)`);
                } else {
                    showAdminResult(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function detectDuplicates() {
            const threshold = parseFloat(document.getElementById('duplicateThreshold').value);

            if (isNaN(threshold) || threshold < 0 || threshold > 1) {
                showAdminResult('Error: Threshold must be between 0.0 and 1.0', true);
                return;
            }

            if (!confirm(`Detect duplicates with threshold ${threshold.toFixed(2)} for persona "${currentPersona}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/detect-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        threshold: threshold,
                        max_pairs: 50
                    })
                });
                const result = await response.json();

                if (result.success) {
                    if (result.duplicates && result.duplicates.length > 0) {
                        showAdminResult(`Found ${result.duplicates.length} duplicate pairs:\n\n${JSON.stringify(result.duplicates, null, 2)}`);
                    } else {
                        showAdminResult('No duplicates found!');
                    }
                } else {
                    showAdminResult(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function mergeMemories() {
            const keysInput = document.getElementById('mergeKeys').value.trim();
            if (!keysInput) {
                showAdminResult('Error: Please enter memory keys (comma-separated)', true);
                return;
            }

            const keys = keysInput.split(',').map(k => k.trim()).filter(k => k);
            if (keys.length < 2) {
                showAdminResult('Error: At least 2 keys are required for merging', true);
                return;
            }

            if (!confirm(`Merge ${keys.length} memories? Original memories will be deleted.`)) return;

            try {
                const response = await fetch('/api/admin/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        keys: keys,
                        keep_all_tags: true,
                        delete_originals: true
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAdminResult(`${result.message}\nNew key: ${result.new_key}`);
                    document.getElementById('mergeKeys').value = '';
                    await refreshData(); // Refresh dashboard data
                } else {
                    showAdminResult(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function generateGraph() {
            if (!confirm(`Generate new knowledge graph for persona "${currentPersona}"?`)) return;

            try {
                const response = await fetch('/api/admin/generate-graph', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        format: 'html',
                        min_count: 2,
                        min_cooccurrence: 1,
                        remove_isolated: true
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showAdminResult(`${result.message}\nURL: ${result.url}`);
                    await refreshData(); // Refresh to show new graph
                } else {
                    showAdminResult(`Error: ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function createSummary() {
            const period = document.getElementById('summaryPeriod').value;

            if (!confirm(`Create ${period} summary for persona "${currentPersona}"?\nThis may take a moment.`)) {
                return;
            }

            showProgress('Creating Summary', 'Starting summarization...');

            try {
                const response = await fetch('/api/admin/summarize-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona: currentPersona,
                        period: period
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));

                            if (data.status === 'progress') {
                                updateProgress(data.percent, data.message);
                            } else if (data.status === 'completed') {
                                updateProgress(100, data.message);
                                setTimeout(() => {
                                    hideProgress();
                                    const summaryInfo = data.summary_key
                                        ? `\n\nüìã Summary Key: ${data.summary_key}`
                                        : '';
                                    showAdminResult(`${data.message}${summaryInfo}`);
                                    refreshData();
                                }, 1000);
                            } else if (data.status === 'error') {
                                hideProgress();
                                showAdminResult(`Error: ${data.message}`, true);
                            }
                        }
                    }
                }
            } catch (error) {
                hideProgress();
                showAdminResult(`Error: ${error.message}`, true);
            }
        }

        async function migrateSchema() {
            if (!confirm(`Migrate database schema for persona "${currentPersona}"?\nThis will add missing columns (importance, equipped_items, etc.)`)) {
                return;
            }

            showAdminResult('Migrating schema...', false);

            try {
                const response = await fetch('/api/admin/migrate-schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona: currentPersona })
                });

                const result = await response.json();

                if (result.success) {
                    showAdminResult(`‚úÖ ${result.message}`, false);
                } else {
                    showAdminResult(`‚ùå ${result.error}`, true);
                }
            } catch (error) {
                showAdminResult(`‚ùå Error: ${error.message}`, true);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Observation Stream ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentObsPage = 1;

        async function loadObservations(page = 1) {
            if (!currentPersona) return;
            const q = document.getElementById('obsSearchQuery')?.value || '';
            const tag = document.getElementById('obsSearchTag')?.value || '';
            const params = new URLSearchParams({ page, per_page: 15 });
            if (q) params.set('q', q);
            if (tag) params.set('tag', tag);

            try {
                const res = await fetch(`/api/observations/${currentPersona}?${params}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                currentObsPage = data.page;
                const container = document.getElementById('observationList');
                if (!data.items.length) {
                    container.innerHTML = '<p class="text-white/60 text-sm">No memories found.</p>';
                } else {
                    container.innerHTML = data.items.map(m => `
                        <div class="glass-card rounded-lg p-3 cursor-pointer hover:bg-white/10 transition-all"
                             onclick="showMemoryDetail('${m.key}')">
                            <div class="flex justify-between items-start gap-2">
                                <div class="flex-1 min-w-0">
                                    <p class="text-white text-sm font-mono truncate">${m.key}</p>
                                    <p class="text-white/70 text-xs mt-1">${m.content_preview || ''}</p>
                                </div>
                                <div class="text-right shrink-0">
                                    ${m.emotion_type ? `<span class="text-xs px-2 py-0.5 rounded-full bg-purple-500/30 text-purple-200">${m.emotion_type}</span>` : ''}
                                    ${m.importance ? `<span class="text-xs text-white/50 ml-1">‚òÖ${Number(m.importance).toFixed(1)}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-1 mt-2 flex-wrap">
                                ${(m.tags || []).map(t => `<span class="text-xs px-1.5 py-0.5 rounded bg-white/10 text-white/60">${t}</span>`).join('')}
                                <span class="text-xs text-white/40 ml-auto">${m.created_at ? new Date(m.created_at).toLocaleString() : ''}</span>
                            </div>
                        </div>
                    `).join('');
                }

                // Pagination
                const pagDiv = document.getElementById('obsPagination');
                if (data.total_pages > 1) {
                    pagDiv.classList.remove('hidden');
                    document.getElementById('obsPageInfo').textContent = `${data.page} / ${data.total_pages} (${data.total} items)`;
                    document.getElementById('obsPrev').disabled = data.page <= 1;
                    document.getElementById('obsNext').disabled = data.page >= data.total_pages;
                } else {
                    pagDiv.classList.add('hidden');
                }
            } catch (err) {
                document.getElementById('observationList').innerHTML = `<p class="text-red-300 text-sm">Error: ${err.message}</p>`;
            }
        }

        async function showMemoryDetail(key) {
            if (!currentPersona) return;
            try {
                const res = await fetch(`/api/memory/${currentPersona}/${key}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                const m = data.memory;
                const tags = (() => { try { return JSON.parse(m.tags || '[]'); } catch { return []; } })();
                const ctx = (() => { try { return JSON.parse(m.context_tags || '[]'); } catch { return []; } })();

                document.getElementById('modalTitle').textContent = `üìÑ ${m.key}`;
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-3">
                        <div class="text-white/90 text-sm whitespace-pre-wrap">${m.content || ''}</div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-white/60">
                            <p>üé≠ Emotion: ${m.emotion_type || 'N/A'} ${m.emotion_intensity ? `(${m.emotion_intensity})` : ''}</p>
                            <p>‚≠ê Importance: ${m.importance || 'N/A'}</p>
                            <p>üè∑Ô∏è Action: ${m.action_tag || 'N/A'}</p>
                            <p>üåç Env: ${m.environment || 'N/A'}</p>
                            <p>üîí Privacy: ${m.privacy_level || 'internal'}</p>
                            <p>üëÅÔ∏è Access: ${m.access_count || 0} times</p>
                            <p>üìÖ Created: ${m.created_at ? new Date(m.created_at).toLocaleString() : 'N/A'}</p>
                            <p>‚úèÔ∏è Updated: ${m.updated_at ? new Date(m.updated_at).toLocaleString() : 'N/A'}</p>
                        </div>
                        ${tags.length ? `<div class="flex gap-1 flex-wrap">${tags.map(t => `<span class="text-xs px-2 py-0.5 rounded-full bg-purple-500/30 text-purple-200">${t}</span>`).join('')}</div>` : ''}
                        ${ctx.length ? `<div class="flex gap-1 flex-wrap">${ctx.map(t => `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-200">${t}</span>`).join('')}</div>` : ''}
                        ${data.linked_keys?.length ? `<div class="mt-2"><p class="text-white/50 text-xs mb-1">Linked Memories:</p>${data.linked_keys.map(k => `<span class="text-xs text-purple-300 underline cursor-pointer mr-2" onclick="showMemoryDetail('${k}')">${k}</span>`).join('')}</div>` : ''}
                        ${data.history?.length ? `
                            <div class="mt-2">
                                <p class="text-white/50 text-xs mb-1">Operation History:</p>
                                <div class="space-y-1 max-h-32 overflow-auto">
                                    ${data.history.map(h => `<p class="text-xs text-white/40">${h.timestamp} ‚Äî ${h.operation} ${h.success ? '‚úÖ' : '‚ùå ' + (h.error || '')}</p>`).join('')}
                                </div>
                            </div>` : ''}
                    </div>
                `;
                document.getElementById('anniversaryModal').classList.remove('hidden');
            } catch (err) {
                alert(`Error loading memory: ${err.message}`);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Audit Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentAuditPage = 1;

        async function loadAuditLog(page = 1) {
            if (!currentPersona) return;
            const op = document.getElementById('auditOpFilter')?.value || '';
            const key = document.getElementById('auditKeyFilter')?.value || '';
            const params = new URLSearchParams({ page, per_page: 30 });
            if (op) params.set('operation', op);
            if (key) params.set('key', key);

            try {
                const res = await fetch(`/api/audit-log/${currentPersona}?${params}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                currentAuditPage = data.page;

                // Breakdown badges
                const bkEl = document.getElementById('auditBreakdown');
                if (data.operation_breakdown) {
                    const colors = { create: 'green', read: 'blue', update: 'yellow', delete: 'red', search: 'purple' };
                    bkEl.innerHTML = Object.entries(data.operation_breakdown).map(([op, cnt]) => {
                        const c = colors[op] || 'white';
                        return `<span class="text-xs px-2 py-0.5 rounded-full bg-${c}-500/30 text-${c}-200">${op}: ${cnt}</span>`;
                    }).join('');
                }

                const container = document.getElementById('auditLogList');
                if (!data.items.length) {
                    container.innerHTML = '<p class="text-white/60 text-sm">No operations found.</p>';
                } else {
                    container.innerHTML = data.items.map(o => {
                        const icon = { create: '‚ûï', read: 'üëÅÔ∏è', update: '‚úèÔ∏è', delete: 'üóëÔ∏è', search: 'üîç' }[o.operation] || 'üìå';
                        return `
                            <div class="flex items-center gap-3 text-xs py-2 border-b border-white/5">
                                <span class="text-lg">${icon}</span>
                                <span class="text-white/50 w-40 shrink-0">${o.timestamp ? new Date(o.timestamp).toLocaleString() : ''}</span>
                                <span class="text-white font-mono">${o.operation}</span>
                                <span class="text-purple-300 truncate flex-1">${o.key || '‚Äî'}</span>
                                <span>${o.success ? '‚úÖ' : '‚ùå'}</span>
                                ${o.error ? `<span class="text-red-300 truncate max-w-48" title="${o.error}">${o.error}</span>` : ''}
                            </div>`;
                    }).join('');
                }

                // Pagination
                const pagDiv = document.getElementById('auditPagination');
                if (data.total_pages > 1) {
                    pagDiv.classList.remove('hidden');
                    document.getElementById('auditPageInfo').textContent = `${data.page} / ${data.total_pages} (${data.total} ops)`;
                    document.getElementById('auditPrev').disabled = data.page <= 1;
                    document.getElementById('auditNext').disabled = data.page >= data.total_pages;
                } else {
                    pagDiv.classList.add('hidden');
                }
            } catch (err) {
                document.getElementById('auditLogList').innerHTML = `<p class="text-red-300 text-sm">Error: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>
